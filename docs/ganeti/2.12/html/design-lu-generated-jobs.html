

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Submitting jobs from logical units &mdash; Ganeti 2.12.6 documentation</title>
    
    <link rel="stylesheet" href="_static/style.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '2.12.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Ganeti 2.12.6 documentation" href="index.html" />
    <link rel="next" title="Ganeti monitoring agent" href="design-monitoring-agent.html" />
    <link rel="prev" title="Linux HA integration" href="design-linuxha.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="design-monitoring-agent.html" title="Ganeti monitoring agent"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="design-linuxha.html" title="Linux HA integration"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Ganeti 2.12.6 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="submitting-jobs-from-logical-units">
<h1><a class="toc-backref" href="#id1">Submitting jobs from logical units</a><a class="headerlink" href="#submitting-jobs-from-logical-units" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#submitting-jobs-from-logical-units" id="id1">Submitting jobs from logical units</a><ul>
<li><a class="reference internal" href="#current-state-and-shortcomings" id="id2">Current state and shortcomings</a></li>
<li><a class="reference internal" href="#proposed-changes" id="id3">Proposed changes</a></li>
<li><a class="reference internal" href="#other-discussed-solutions" id="id4">Other discussed solutions</a></li>
</ul>
</li>
</ul>
</div>
<p>This is a design document about the innards of Ganeti&#8217;s job processing.
Readers are advised to study previous design documents on the topic:</p>
<ul class="simple">
<li><a class="reference internal" href="design-2.0.html#jqueue-original-design"><em>Original job queue</em></a></li>
<li><a class="reference internal" href="design-2.3.html#jqueue-job-priority-design"><em>Job priorities</em></a></li>
</ul>
<div class="section" id="current-state-and-shortcomings">
<h2><a class="toc-backref" href="#id2">Current state and shortcomings</a><a class="headerlink" href="#current-state-and-shortcomings" title="Permalink to this headline">¶</a></h2>
<p>Some Ganeti operations want to execute as many operations in parallel as
possible. Examples are evacuating or failing over a node (<tt class="docutils literal"><span class="pre">gnt-node</span>
<span class="pre">evacuate</span></tt>/<tt class="docutils literal"><span class="pre">gnt-node</span> <span class="pre">failover</span></tt>). Without changing large parts of the
code, e.g. the RPC layer, to be asynchronous, or using threads inside a
logical unit, only a single operation can be executed at a time per job.</p>
<p>Currently clients work around this limitation by retrieving the list of
desired targets and then re-submitting a number of jobs. This requires
logic to be kept in the client, in some cases leading to duplication
(e.g. CLI and RAPI).</p>
</div>
<div class="section" id="proposed-changes">
<h2><a class="toc-backref" href="#id3">Proposed changes</a><a class="headerlink" href="#proposed-changes" title="Permalink to this headline">¶</a></h2>
<p>The job queue lock is guaranteed to be released while executing an
opcode/logical unit. This means an opcode can talk to the job queue and
submit more jobs. It then receives the job IDs, like any job submitter
using the LUXI interface would. These job IDs are returned to the
client, who then will then proceed to wait for the jobs to finish.</p>
<p>Technically, the job queue already passes a number of callbacks to the
opcode processor. These are used for giving user feedback, notifying the
job queue of an opcode having gotten its locks, and checking whether the
opcode has been cancelled. A new callback function is added to submit
jobs. Its signature and result will be equivalent to the job queue&#8217;s
existing <tt class="docutils literal"><span class="pre">SubmitManyJobs</span></tt> function.</p>
<p>Logical units can submit jobs by returning an instance of a special
container class with a list of jobs, each of which is a list of opcodes
(e.g.  <tt class="docutils literal"><span class="pre">[[op1,</span> <span class="pre">op2],</span> <span class="pre">[op3]]</span></tt>). The opcode processor will recognize
instances of the special class when used a return value and will submit
the contained jobs. The submission status and job IDs returned by the
submission callback are used as the opcode&#8217;s result. It should be
encapsulated in a dictionary allowing for future extensions.</p>
<p>Example:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;jobs&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">(</span><span class="nx">True</span><span class="p">,</span> <span class="s2">&quot;8149&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="nx">True</span><span class="p">,</span> <span class="s2">&quot;21019&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="nx">False</span><span class="p">,</span> <span class="s2">&quot;Submission failed&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="nx">True</span><span class="p">,</span> <span class="s2">&quot;31594&quot;</span><span class="p">),</span>
    <span class="p">],</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Job submissions can fail for variety of reasons, e.g. a full or drained
job queue. Lists of jobs can not be submitted atomically, meaning some
might fail while others succeed. The client is responsible for handling
such cases.</p>
</div>
<div class="section" id="other-discussed-solutions">
<h2><a class="toc-backref" href="#id4">Other discussed solutions</a><a class="headerlink" href="#other-discussed-solutions" title="Permalink to this headline">¶</a></h2>
<p>Instead of requiring the client to wait for the returned jobs, another
idea was to do so from within the submitting opcode in the master
daemon. While technically possible, doing so would have two major
drawbacks:</p>
<ul class="simple">
<li>Opcodes waiting for other jobs to finish block one job queue worker
thread</li>
<li>All locks must be released before starting the waiting process,
failure to do so can lead to deadlocks</li>
</ul>
<p>Instead of returning the job IDs as part of the normal opcode result,
introducing a new opcode field, e.g. <tt class="docutils literal"><span class="pre">op_jobids</span></tt>, was discussed and
dismissed. A new field would touch many areas and possibly break some
assumptions. There were also questions about the semantics.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Submitting jobs from logical units</a><ul>
<li><a class="reference internal" href="#current-state-and-shortcomings">Current state and shortcomings</a></li>
<li><a class="reference internal" href="#proposed-changes">Proposed changes</a></li>
<li><a class="reference internal" href="#other-discussed-solutions">Other discussed solutions</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="design-linuxha.html"
                        title="previous chapter">Linux HA integration</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="design-monitoring-agent.html"
                        title="next chapter">Ganeti monitoring agent</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/design-lu-generated-jobs.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="design-monitoring-agent.html" title="Ganeti monitoring agent"
             >next</a></li>
        <li class="right" >
          <a href="design-linuxha.html" title="Linux HA integration"
             >previous</a> |</li>
        <li><a href="index.html">Ganeti 2.12.6 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013 Google Inc..
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>